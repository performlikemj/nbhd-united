# Journal Migration Plan: nbhd-united ‚Üí neighborhood-united (Sautai)

## Problem
The journal feature was built in the **NBHD platform repo** (nbhd-united) but belongs in the **Sautai repo** (neighborhood-united). Templates also contain hardcoded personal references ("The Claw", "Sautai", "Academy Watch") instead of being dynamic per-user.

## What Needs to Move

### Backend (Django) ‚Äî `apps/journal/` ‚Üí new `journal/` app in Sautai

| File | Lines | What it does |
|------|-------|-------------|
| `models.py` | 173 | JournalEntry, WeeklyReview, DailyNote, NoteTemplate, UserMemory, Document (v2) |
| `views.py` | 514 | REST endpoints for journal entries, weekly reviews |
| `document_views.py` | 277 | CRUD for v2 Document model (daily notes, goals, projects, etc.) |
| `serializers.py` | 383 | DRF serializers for journal/review models |
| `document_serializers.py` | 42 | DRF serializers for Document model |
| `services.py` | 383 | Business logic, auto-creation, workspace sync |
| `tasks.py` | 58 | Celery tasks (sync_documents_to_workspace) |
| `signals.py` | 27 | Signal handlers |
| `templates_md.py` | 225 | Markdown templates (**needs rewrite ‚Äî see below**) |
| `md_utils.py` | 261 | Markdown parsing utilities |
| `urls.py` | 46 | URL routing |
| `tests.py` | 993 | Test suite |
| `migrations/` | 6 files | Database migrations |
| `management/commands/seed_missing_journal_templates.py` | ‚Äî | Management command |

**Total: ~3,400 lines of Python**

### Frontend (Next.js) ‚Äî move to Sautai frontend

| Path | What it does |
|------|-------------|
| `app/journal/page.tsx` | Journal list/index page |
| `app/journal/today/page.tsx` | Today's daily note |
| `app/journal/memory/page.tsx` | Long-term memory view |
| `app/journal/templates/page.tsx` | Template management |
| `app/journal/layout.tsx` | Journal layout with sidebar |
| `components/journal/sidebar.tsx` | Journal navigation sidebar |
| `components/journal/document-view.tsx` | Document renderer |
| `components/journal/markdown-editor.tsx` | Markdown editor component |
| `components/journal/markdown-help-sheet.tsx` | Help overlay |
| `components/journal/quick-log-input.tsx` | Quick journal entry input |

### API Routes Referenced
- `GET/POST /api/v1/journal/entries/`
- `GET/PATCH/DELETE /api/v1/journal/entries/<id>/`
- `GET/POST /api/v1/journal/reviews/`
- `GET/POST /api/v1/journal/documents/`
- `GET/PATCH/DELETE /api/v1/journal/documents/<id>/`
- `POST /api/v1/journal/documents/sidebar-tree/`
- `GET /api/v1/journal/templates/`

### Cross-references to Update in nbhd-united
- `apps/cron/views.py` ‚Äî references `sync_documents_to_workspace` task
- `apps/orchestrator/config_generator.py` ‚Äî evening check-in prompt mentions journal
- Frontend sidebar/navigation ‚Äî journal links
- Any OpenClaw agent tool configs that reference journal endpoints

---

## Template Rewrite (Critical)

Current templates are hardcoded with personal data. They need to be **dynamic per-user**.

### What to Replace

| Current (hardcoded) | Should be |
|---------------------|-----------|
| `*Generated by The Claw*` | `*Generated by your assistant*` or agent's configured name |
| `**Sautai:**` | User's own project/goal names (from their profile or goals) |
| `**Academy Watch:**` | ‚Üë same |
| `**NBHD United:**` | ‚Üë same |
| `*Notes for The Claw*` | `*Notes for your assistant*` |
| Fixed goal categories | Pull from user's active goals/projects, or use empty prompts |

### Approach
Templates should accept a **context dict** that includes:
- `assistant_name` ‚Äî the tenant's agent display name (or "your assistant")
- `user_projects` ‚Äî list of the user's active project names (for goal sections)
- `user_timezone` ‚Äî for date formatting
- `user_display_name` ‚Äî optional personalization

The `render_template()` function already supports `{{variable}}` substitution ‚Äî just needs more variables passed in.

### Example: Weekly Review (after fix)
```markdown
# Weekly Review ‚Äî {{date}}

## üèÜ Wins this week
- 

## ‚ùå What didn't work?
- 

## üéØ Goal progress
{{#each projects}}
- **{{name}}:** 
{{/each}}

## üìÖ Next week's focus
1. 
2. 
3. 
```

If the user has no projects yet, show a simple prompt:
```markdown
## üéØ Goal progress
*Add your projects in the Goals section to track progress here.*
```

---

## Migration Steps

### Phase 1: Template Fix (quick win, do first)
1. Rewrite `templates_md.py` to remove all personal references
2. Make templates dynamic with user context
3. Deploy to nbhd-united immediately (users are seeing "Sautai" now)

### Phase 2: Create Journal App in Sautai
1. Create `journal/` Django app in neighborhood-united
2. Copy and adapt models (change Tenant FK ‚Üí User FK since Sautai doesn't have multi-tenancy)
3. Copy and adapt views, serializers, services
4. Write fresh migrations for Sautai's DB
5. Add URL routing to Sautai's `urls.py`

### Phase 3: Frontend Migration
1. Copy journal components to Sautai frontend
2. Adapt API calls to Sautai's API structure
3. Integrate with Sautai's existing navigation/layout
4. Connect to Sautai's user model (not tenant model)

### Phase 4: Clean Up nbhd-united
1. Decide: keep journal in NBHD too (as a platform feature) or remove it?
2. If keeping: the templates are already fixed from Phase 1
3. If removing: drop the app, migrations, frontend pages

---

## Key Decision Needed from MJ
- **Keep journal in NBHD as a platform feature too?** It works as a general journaling tool for any NBHD user. Or is it Sautai-only?
- **Sautai user model:** Journal uses `Tenant` FK in NBHD. Sautai uses Django `User` directly. Need to adapt the FK references.

---

## Estimate
- Phase 1 (template fix): ~1 hour
- Phase 2 (backend migration): ~3-4 hours  
- Phase 3 (frontend migration): ~2-3 hours
- Phase 4 (cleanup): ~1 hour
- **Total: ~7-9 hours of sub-agent work**
